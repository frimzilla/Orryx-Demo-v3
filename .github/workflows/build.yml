name: EAS Build and QR Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate package.json
        run: |
          node -e "const fs=require('fs');try{JSON.parse(fs.readFileSync('package.json','utf8'));console.log('package.json OK ‚úÖ')}catch(e){console.error('‚ùå Invalid package.json:',e.message);process.exit(1)}"

      # ‚îÄ‚îÄ Accurate 20-bar dependency progress (caps at 99% until success) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Install dependencies (20-bar accurate progress)
        shell: bash
        run: |
          set -euo pipefail

          estimate() {
            local est
            est=$(npm ci --dry-run --json 2>/dev/null | node -e "let s='';process.stdin.on('data',c=>s+=c).on('end',()=>{try{const j=JSON.parse(s);const a=(j.added||0)+(j.changed||0)+(j.removed||0);console.log(a||0)}catch{console.log(0)}})") || est=0
            if [ "$est" -gt 0 ]; then echo "$est"; return; fi
            if [ -f package-lock.json ]; then
              est=$(node -e "try{const j=require('./package-lock.json');const pkgs=j.packages?Object.keys(j.packages).length:0;console.log(pkgs||0)}catch{console.log(0)}") || est=0
              if [ "$est" -gt 0 ]; then echo "$est"; return; fi
            fi
            echo 400
          }

          TOTAL=$(estimate); [ "$TOTAL" -le 0 ] && TOTAL=400

          if [ -f package-lock.json ]; then
            ( npm ci --silent --no-audit --no-fund ) & pid=$!
          else
            ( npm install --silent --no-audit --no-fund ) & pid=$!
          fi

          MAX=20; LASTPCT=-1
          draw_bar () {
            local pct=$1; local filled=$(( pct * MAX / 100 ))
            (( filled > MAX )) && filled=$MAX
            local empty=$(( MAX - filled ))
            printf "["
            printf "%0.s|" $(seq 1 $filled)
            printf "%0.s " $(seq 1 $empty)
            printf "] %3d%%" "$pct"
          }

          echo -n "Installing dependencies "
          while kill -0 "$pid" >/dev/null 2>&1; do
            if [ -d node_modules ]; then
              COUNT=$(find node_modules -type f -name package.json 2>/dev/null | wc -l | tr -d ' ')
              [ "$COUNT" -lt 1 ] && COUNT=1
            else
              COUNT=1
            fi
            PCT=$(( COUNT * 100 / TOTAL ))
            [ "$PCT" -gt 99 ] && PCT=99
            if [ "$PCT" -ne "$LASTPCT" ]; then
              printf "\r"; draw_bar "$PCT"; LASTPCT=$PCT
            fi
            sleep 0.25
          done

          if wait "$pid"; then
            printf "\r"; draw_bar 100; echo -e "\n‚úÖ Dependencies installed"
          else
            echo -e "\n‚ùå npm install failed"; exit 1
          fi

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Verify EXPO_TOKEN secret
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "::error ::‚ùå EXPO_TOKEN secret is missing. Add it under Settings ‚Üí Secrets ‚Üí Actions."
            exit 1
          else
            echo "‚úÖ EXPO_TOKEN detected. Proceeding with build."
          fi

      - name: Run EAS Build (Android, profile=internal)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas --version
          eas build -p android --profile internal --non-interactive --json | tee eas-build.json

      - name: Extract EAS build URL (primary)
        run: |
          node <<'NODE'
          const fs = require('fs');
          let url='', status='', err='';
          try {
            const txt = fs.readFileSync('eas-build.json','utf8').trim();
            if (txt) {
              const j = JSON.parse(txt);
              const b = Array.isArray(j.builds) ? j.builds[0] : j;
              status = b?.status || j?.status || '';
              url = b?.webUrl || b?.buildUrl || b?.logsUrl || '';
              err = b?.error?.message || j?.error?.message || '';
            }
          } catch(e) {
            console.error('‚ùå Parse error:', e.message);
          }
          if (status && status !== 'finished') console.log('EAS status:', status);
          if (!url && err) console.log('EAS error:', err);
          console.log('EAS build page:', url || '(not found)');
          fs.writeFileSync('eas-build-url.txt', (url||'').trim());
          fs.writeFileSync('README.txt', url ? `Open this URL for the QR code:\n${url}\n` : 'Build failed or URL not found.\n');
          NODE

      - name: Recover URL from latest finished build (fallback)
        if: always()
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ ! -s eas-build-url.txt ]; then
            echo "No URL from primary JSON; trying eas build:list fallback‚Ä¶"
            eas build:list --platform android --status finished --limit 1 --json > eas-fallback.json || true
            node <<'NODE'
            const fs = require('fs');
            try {
              const j = JSON.parse(fs.readFileSync('eas-fallback.json','utf8'));
              const b = Array.isArray(j) ? j[0] : j;
              const url = (b && (b.webUrl || b.buildUrl || b.logsUrl)) || '';
              if (url) {
                console.log('Recovered EAS build page:', url);
                fs.writeFileSync('eas-build-url.txt', url);
                fs.writeFileSync('README.txt', `Open this URL for the QR code:\n${url}\n`);
              } else {
                console.log('No finished builds found in fallback.');
              }
            } catch(e) {
              console.log('Fallback parse error:', e.message);
            }
            NODE
          fi

      - name: Install QR tool
        run: npm install -g qrcode-terminal

      - name: Print QR in logs
        if: always()
        run: |
          if [ -s eas-build-url.txt ]; then
            URL="$(cat eas-build-url.txt)"
            echo "üîó $URL"
            qrcode-terminal "$URL"
          else
            echo "‚ö†Ô∏è No EAS URL found; skipping QR."
            echo "Tip: Check 'eas-build.json' and (if present) 'eas-fallback.json' artifacts."
          fi

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eas-android-internal-build
          path: |
            eas-build.json
            eas-fallback.json
            eas-build-url.txt
            README.txt
